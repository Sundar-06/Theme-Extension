<script src="{{ 'cartSync.js' | asset_url }}" defer></script>

<!-- cart_sync.liquid -->
<div id="cart-loader" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.8); z-index: 9999; align-items: center; justify-content: center;">
  <div style="font-size: 20px; color: #000;">Syncing cart, please wait...</div>
</div>


<script>
  window.customerData = {
    isLoggedIn: {% if customer %}true{% else %}false{% endif %},
    email: {% if customer %}"{{ customer.email }}"{% else %}null{% endif %},
    id: {% if customer %}{{ customer.id }}{% else %}null{% endif %}
  };


  //to clear cart
//  await fetch('/cart/clear.js', { method: 'POST' });
   
  if (window.customerData && window.customerData.isLoggedIn) {
    console.log("Customer is logged in");
    console.log("Email:", window.customerData.email);
    console.log("Customer ID:", window.customerData.id);

    document.addEventListener('DOMContentLoaded', () => {
      document.body.addEventListener('submit', async (e) => {
        const form = e.target;
    
        if (form.action.includes('/cart/add')) {
          setTimeout(async () => {
            try {
              const cart = await fetch('/cart.js').then(res => res.json());
    
              console.log('Fetched cart:', cart);
    
              if (window.customerData && window.customerData.isLoggedIn) {
                const payload = {
                  customerId: window.customerData.id?.toString() || '',
                  email: window.customerData.email || '',
                  lineItems: cart.items.map(item => ({...item}))
                };
                console.log("Payload:", payload);

                const response = await fetch('https://express-application-7ye7.onrender.com/api/cart', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
    
                if (!response.ok) {
                  throw new Error(`Server error: ${response.status}`);
                }
    
                console.log('Cart successfully sent to server');
              } else {
                console.log('Customer not logged in â€“ skipping cart sync');
              }
            } catch (err) {
              console.error('Error during cart sync:', err);
            }
          }, 1000); // Delay to let Shopify update cart
        }
      });
    });
    

  } else {
    console.log("Customer is not logged in");
  }
</script>

{% schema %}
{
  "name": "cart-sync",
  "target": "body",
  "settings": []
}
{% endschema %}
